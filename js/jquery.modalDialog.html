<!DOCTYPE html><html lang="en"><head><title>js\jquery.modalDialog</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="js\jquery.modalDialog"><meta name="groc-project-path" content="js\jquery.modalDialog.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">js\jquery.modalDialog.js</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><a href="../index.html">Homepage</a> | 
<a href="https://github.com/vistaprint/SkinnyJS/blob/master/js/jquery.modalDialog.js" target="_blank">View this file on Github</a> | 
<a href="https://raw.github.com/vistaprint/SkinnyJS/master/js/jquery.modalDialog.js" target="_blank">Download this file</a>

<hr style="height: 1px; border:0; background-color:#4A525A">
<h2 id="jquerymodaldialog">jQuery.modalDialog</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="documentation">Documentation</h3>

<p>Full documentation is available at <a href="http://vistaprint.github.io/SkinnyJS/modal-dialogs.html">http://vistaprint.github.io/SkinnyJS/modal-dialogs.html</a></p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Note: jQuery Mobile and some other dialog frameworks have URL/history management via pushState/hashchange built in.
I find this to be too inflexible, and should be implemented by callers as a separate concern.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="source">Source</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Minimal polyfill for Object.keys
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/keys">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/keys</a></p></div></div><div class="code"><div class="wrapper"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> 
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> 
            <span class="p">{</span>
                <span class="nx">keys</span><span class="p">[</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">keys</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">$</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span> <span class="o">&amp;&amp;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">_isContent</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Attempt to load jquery.modalDialogContent.js in the same window as jquery.modalDialog.js.&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">MARGIN</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="c1">// @see MARGIN in jquery.modalDialog.less</span>
    <span class="kd">var</span> <span class="nx">DURATION</span> <span class="o">=</span> <span class="mi">600</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">STARTING_TOP</span> <span class="o">=</span> <span class="s2">&quot;-700px&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A stack of dialogs in display order</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">_dialogStack</span> <span class="o">=</span> <span class="p">[];</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A map of dialogs by full ID</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">_fullIdMap</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="kd">var</span> <span class="nx">zIndex</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Default values</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">_defaults</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="c1">// The title to display in the title bar of the dialog</span>
        <span class="nx">maxWidth</span><span class="o">:</span> <span class="mi">600</span><span class="p">,</span> <span class="c1">// Sets the maximum width of the dialog. Note that on small mobile devices, the actual width may be smaller, so you should design the dialog content accordingly</span>
        <span class="nx">initialHeight</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span> <span class="c1">// Only FramedModalDialog uses this. Consider this internal for now.</span>
        <span class="nx">skin</span><span class="o">:</span> <span class="s2">&quot;primary&quot;</span><span class="p">,</span> <span class="c1">// The name of the skin to use for the dialog</span>
        <span class="nx">ajax</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="c1">// Determines how the url setting is interpreted. If true, the URL is the source for an AJAX dialog. If false, it will be the URL of an IFrame dialog</span>
        <span class="nx">url</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="c1">// The URL for the content of an IFrame or AJAX dialog</span>
        <span class="nx">content</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="c1">// A CSS selector or jQuery object for a content node to use for a node dialog</span>
        <span class="nx">destroyOnClose</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="c1">// If true, the dialog DOM will be destroyed and all events removed when the dialog closes</span>
        <span class="nx">containerElement</span><span class="o">:</span> <span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="c1">// A CSS selector or jQuery object for the element that should be the parent for the dialog DOM (useful for working with jQuery mobile)</span>
        <span class="nx">preventEventBubbling</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">// If true, click and touch events are prevented from bubbling up to the document</span>
        <span class="nx">onopen</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">onclose</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">onbeforeclose</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">onajaxerror</span><span class="o">:</span> <span class="kc">null</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If the jquery.transit library is loaded, use CSS3 transitions instead of jQuery.animate()</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">_animateMethod</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">transition</span> <span class="o">?</span> <span class="s2">&quot;transition&quot;</span> <span class="o">:</span> <span class="s2">&quot;animate&quot;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_easing</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">transition</span> <span class="o">?</span> <span class="s2">&quot;out&quot;</span> <span class="o">:</span> <span class="s2">&quot;swing&quot;</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">_ua</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">_ua</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Class which creates a jQuery mobile dialog</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">ModalDialog</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">settings</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">settings</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">containerElement</span> <span class="o">||</span> <span class="s2">&quot;body&quot;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Creates event objects on the dialog and copies handlers from settings</p></div></div><div class="code"><div class="wrapper">        <span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">([</span><span class="s2">&quot;open&quot;</span><span class="p">,</span> <span class="s2">&quot;beforeopen&quot;</span><span class="p">,</span> <span class="s2">&quot;close&quot;</span><span class="p">,</span> <span class="s2">&quot;beforeclose&quot;</span><span class="p">,</span> <span class="s2">&quot;ajaxerror&quot;</span><span class="p">],</span> <span class="nx">$</span><span class="p">.</span><span class="nx">proxy</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_setupCustomEvent</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Bind methods called as handlers so "this" works</p></div></div><div class="code"><div class="wrapper">        <span class="nx">$</span><span class="p">.</span><span class="nx">proxyAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s2">&quot;_drag&quot;</span><span class="p">,</span> <span class="s2">&quot;_startDrag&quot;</span><span class="p">,</span> <span class="s2">&quot;_stopDrag&quot;</span><span class="p">,</span> <span class="s2">&quot;_close&quot;</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">dialogType</span> <span class="o">=</span> <span class="s2">&quot;node&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Creates a custom event on this object with the specified event name</p></div></div><div class="code"><div class="wrapper">    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_setupCustomEvent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">eventName</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">onEvent</span> <span class="o">=</span> <span class="s2">&quot;on&quot;</span> <span class="o">+</span> <span class="nx">eventName</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">evt</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">CustomEvent</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">eventName</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">handler</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">[</span><span class="nx">onEvent</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">handler</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">evt</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">handler</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">evt</span><span class="p">;</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Opens the dialog</p></div></div><div class="code"><div class="wrapper">    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">open</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: Re-evaluate settings, change DOM if settings have changed.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Ensure the dialog doesn't open once its already opened.. 
Otherwise, you could end up pushing it on to the stack more than once.</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_open</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Description</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">level</span> <span class="o">=</span> <span class="nx">_dialogStack</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fire onbeforeopen on this instance</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">evt</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">onbeforeopen</span><span class="p">.</span><span class="nx">fire</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">isDefaultPrevented</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fire onbeforeopen globally</p></div></div><div class="code"><div class="wrapper">        <span class="nx">evt</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">onbeforeopen</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">isDefaultPrevented</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Keep track of the dialog stacking order</p></div></div><div class="code"><div class="wrapper">        <span class="nx">_dialogStack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_open</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_build</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add or remove the 'smallscreen' class (which can also be checked using CSS media queries)</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">.</span><span class="nx">stop</span><span class="p">()[</span><span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">isSmallScreen</span><span class="p">()</span> <span class="o">?</span> <span class="s2">&quot;addClass&quot;</span> <span class="o">:</span> <span class="s2">&quot;removeClass&quot;</span> <span class="p">](</span><span class="s2">&quot;smallscreen&quot;</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_showLoadingIndicator</span><span class="p">();</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_finishOpenAction</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$bg</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">veilClass</span><span class="p">);</span>

            <span class="kd">var</span> <span class="nx">initialPos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getDefaultPosition</span><span class="p">(),</span>
                <span class="nx">initialTop</span> <span class="o">=</span> <span class="nx">initialPos</span><span class="p">.</span><span class="nx">top</span><span class="p">;</span>
            <span class="nx">initialPos</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="nx">STARTING_TOP</span><span class="p">;</span> <span class="c1">// we&#39;re going to animate this to slide down</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="nx">initialPos</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Animate with a CSS transition</p></div></div><div class="code"><div class="wrapper">            <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">[</span><span class="nx">_animateMethod</span><span class="p">](</span>
                <span class="p">{</span> <span class="nx">top</span><span class="o">:</span> <span class="nx">initialTop</span> <span class="p">},</span>
                <span class="nx">DURATION</span><span class="p">,</span>
                <span class="nx">_easing</span><span class="p">,</span>
                <span class="nx">$</span><span class="p">.</span><span class="nx">proxy</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span>
                <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;dialog-visible&quot;</span><span class="p">);</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">isSmallScreen</span><span class="p">())</span>
                    <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: I question this change. Should it be decoupled from the dialog framework?
It could be put into mobile fixes.
Is this even mobile specific?
Original comment:
Force dialogs that are on small screens to trigger a window resize event when closed, just in case we have resized since the dialog opened.</p></div></div><div class="code"><div class="wrapper">                        <span class="k">this</span><span class="p">.</span><span class="nx">triggerWindowResize</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">_orientationchange</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">proxy</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">triggerWindowResize</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
                        <span class="p">},</span> <span class="k">this</span><span class="p">);</span>

                        <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;orientationchange resize&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_orientationchange</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="k">this</span><span class="p">.</span><span class="nx">onopen</span><span class="p">.</span><span class="nx">fire</span><span class="p">();</span>

                    <span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">onopen</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
                <span class="p">},</span> <span class="k">this</span><span class="p">)</span>
            <span class="p">);</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">_hideLoadingIndicator</span><span class="p">();</span>
        <span class="p">};</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_finishOpen</span><span class="p">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_finishOpen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_finishOpenAction</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_finishOpenAction</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_finishOpenAction</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_showLoadingIndicator</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">$loadingIndicator</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$loadingIndicator</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;div class=&#39;dialog-loading-indicator&#39;&gt;&lt;span&gt;&lt;/span&gt;&lt;/div&gt;&quot;</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">appendTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$bg</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;z-index&quot;</span><span class="p">,</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$bg</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;z-index&quot;</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_hideLoadingIndicator</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$loadingIndicator</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$loadingIndicator</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Closes the dialog. 
isDialogCloseButton Indicates the cancel button in the dialog's header was clicked.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">close</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">isDialogCloseButton</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">getCurrent</span><span class="p">()</span> <span class="o">!==</span> <span class="k">this</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t close a dialog that isn&#39;t currently displayed on top.&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">eventSettings</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">isDialogCloseButton</span><span class="o">:</span> <span class="o">!!</span><span class="nx">isDialogCloseButton</span> <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Expose an event allowing consumers to cancel the close event</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">onbeforeclose</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">eventSettings</span><span class="p">).</span><span class="nx">isDefaultPrevented</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Expose a global event</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">onbeforeclose</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">eventSettings</span><span class="p">,</span> <span class="k">this</span><span class="p">).</span><span class="nx">isDefaultPrevented</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">getCurrent</span><span class="p">()</span> <span class="o">===</span> <span class="k">this</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">_dialogStack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s2">&quot;dialog-visible&quot;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">[</span><span class="nx">_animateMethod</span><span class="p">](</span>
            <span class="p">{</span><span class="nx">top</span><span class="o">:</span> <span class="nx">STARTING_TOP</span><span class="p">},</span>
            <span class="nx">DURATION</span><span class="p">,</span>
            <span class="nx">_easing</span><span class="p">,</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">proxy</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_finishClose</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">eventSettings</span><span class="p">)</span>
        <span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>unbind global event listeners</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_orientationchange</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">off</span><span class="p">(</span><span class="s2">&quot;orientationchange resize&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_orientationchange</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_close</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_finishClose</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_open</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">$bg</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">veilClass</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">destroyOnClose</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_destroy</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_destroyed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="k">delete</span> <span class="nx">_fullIdMap</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">_fullId</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">onclose</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>

        <span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">onclose</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">isSmallScreen</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">triggerWindowResize</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;resize&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_destroy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Put the content node back on the body.
It could be used again.</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">$content</span><span class="p">.</span><span class="nx">detach</span><span class="p">().</span><span class="nx">appendTo</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Builds the DOM for the dialog chrome</p></div></div><div class="code"><div class="wrapper">    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_build</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="cm">/*jshint quotmark:false*/</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_destroyed</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;This dialog has been destroyed&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$bg</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;div class=&quot;dialog-background&quot;&gt;&lt;/div&gt;&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;z-index&#39;</span><span class="p">,</span> <span class="o">++</span><span class="nx">zIndex</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>increase the z-index again to consider the loading indicator</p></div></div><div class="code"><div class="wrapper">            <span class="nx">zIndex</span><span class="o">++</span><span class="p">;</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">$container</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span>
                <span class="s1">&#39;&lt;div class=&quot;dialog-container&quot; id=&quot;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">_fullId</span> <span class="o">+</span> <span class="s1">&#39;Container&quot;&gt;&#39;</span> <span class="o">+</span>
                <span class="s1">&#39;  &lt;div class=&quot;dialog-header&quot;&gt;&#39;</span> <span class="o">+</span>
                <span class="s1">&#39;    &lt;a href=&quot;#&quot; class=&quot;dialog-close-button&quot;&gt;&lt;span class=&quot;dialog-close-button-icon&quot;&gt;&lt;/span&gt;&lt;/a&gt;&#39;</span> <span class="o">+</span>
                <span class="s1">&#39;    &lt;h1&gt;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">title</span> <span class="o">+</span> <span class="s1">&#39;&lt;/h1&gt;&#39;</span> <span class="o">+</span>
                <span class="s1">&#39;  &lt;/div&gt;&#39;</span><span class="o">+</span>
                <span class="s1">&#39;  &lt;div class=&quot;dialog-content-container&quot;&gt;&#39;</span> <span class="o">+</span>
                <span class="s1">&#39;  &lt;/div&gt;&#39;</span> <span class="o">+</span>
                <span class="s1">&#39;&lt;/div&gt;&#39;</span>
            <span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;z-index&#39;</span><span class="p">,</span> <span class="o">++</span><span class="nx">zIndex</span><span class="p">);</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span> <span class="o">=</span> <span class="nx">$</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">$bg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">[</span><span class="mi">0</span><span class="p">]]).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;dialog-skin-&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">skin</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Figure out where to put the dialog DOM. In jQuery mobile, the root element needs to be specific.
It's not for us to fix developer problems, if the container doesn't exist, this will break</p></div></div><div class="code"><div class="wrapper">            <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$bg</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="s2">&quot;ui-page-active&quot;</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">$bg</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="s2">&quot;absolute&quot;</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;position&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;static&quot;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="s2">&quot;relative&quot;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="cm">/*          </span>
<span class="cm">            if (this.settings.preventEventBubbling)</span>
<span class="cm">            {</span>
<span class="cm">                this.$el.on(&quot;click mousemove mousedown mouseup touchstart touchmove touchend&quot;, function(e) { e.stopPropagation(); });</span>
<span class="cm">            }</span>
<span class="cm">            */</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">$contentContainer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.dialog-content-container&quot;</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$header</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.dialog-header&quot;</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$closeButton</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.dialog-close-button&quot;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_close</span><span class="p">);</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">_buildContent</span><span class="p">();</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">$content</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;*[data-action=&quot;close&quot;]&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_close</span><span class="p">);</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">$contentContainer</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$content</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>only enable dragging if the dialog is over the entire window
and we are not in Internet Explorer 7, because it handles positioning oddly.</p></div></div><div class="code"><div class="wrapper">            <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="s2">&quot;ui-page-active&quot;</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_ua</span><span class="p">.</span><span class="nx">ie7</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">_makeDraggable</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_alreadyBuilt</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Subclasses should override to do something when a cached DOM is used</p></div></div><div class="code"><div class="wrapper">    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_alreadyBuilt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>noop</p></div></div><div class="code"><div class="wrapper">    <span class="p">};</span>

    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_getChromeHeight</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_chromeHeight</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_chromeHeight</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">$content</span><span class="p">.</span><span class="nx">height</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_chromeHeight</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_getDefaultPosition</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">contentHeight</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">$win</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">),</span>
            <span class="nx">windowWidth</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerWidth</span> <span class="o">||</span> <span class="nx">$win</span><span class="p">.</span><span class="nx">width</span><span class="p">()</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">width</span><span class="p">(),</span>
            <span class="nx">pos</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="nx">pos</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">windowWidth</span> <span class="o">-</span> <span class="p">(</span><span class="nx">MARGIN</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">maxWidth</span><span class="p">);</span>
        <span class="nx">pos</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">scrollTop</span><span class="p">()</span> <span class="o">+</span> <span class="nx">MARGIN</span><span class="p">;</span>
        <span class="nx">pos</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="p">(</span><span class="nx">windowWidth</span> <span class="o">-</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">_ua</span><span class="p">.</span><span class="nx">ie7</span><span class="p">)</span> 
        <span class="p">{</span>
            <span class="nx">pos</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="nx">MARGIN</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>For small mobile devices, always position at the top.
No need to consider contentHeight.
For larger devices, center vertically.</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">isSmallScreen</span><span class="p">())</span> 
        <span class="p">{</span>
            <span class="nx">contentHeight</span> <span class="o">=</span> <span class="nx">contentHeight</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">$content</span><span class="p">.</span><span class="nx">height</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get the new container height with the proposed content height</p></div></div><div class="code"><div class="wrapper">            <span class="kd">var</span> <span class="nx">containerHeight</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getChromeHeight</span><span class="p">()</span> <span class="o">+</span> <span class="nx">contentHeight</span><span class="p">;</span>

            <span class="kd">var</span> <span class="nx">parentHeight</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">height</span><span class="p">()</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">height</span><span class="p">();</span>
            <span class="kd">var</span> <span class="nx">idealTop</span> <span class="o">=</span> <span class="p">(</span><span class="nx">parentHeight</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nx">containerHeight</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

            <span class="nx">pos</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">idealTop</span><span class="p">,</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">top</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">pos</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_makeDraggable</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Small devices shouldn't have the dialog be draggable.
Where you gonna drag to?</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">isSmallScreen</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">$header</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;draggable&quot;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mousedown touchstart&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_startDrag</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_startDrag</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">$target</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">);</span>

        <span class="c1">//Don&#39;t drag if the close button is being clicked</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">$target</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$closeButton</span><span class="p">)</span> <span class="o">||</span> <span class="nx">$target</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$closeButton</span><span class="p">.</span><span class="nx">children</span><span class="p">()))</span>
        <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_initialMousePos</span> <span class="o">=</span> <span class="nx">getMousePos</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_initialDialogPos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">.</span><span class="nx">offset</span><span class="p">();</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mousemove touchmove&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_drag</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make sure the mouseup also works on the background</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">$bg</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseup touchend&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_stopDrag</span><span class="p">);</span>

        <span class="c1">//chrome node is the last element that can handle events- it has cancel bubble set</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseup touchend&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_stopDrag</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$frame</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">$frame</span><span class="p">.</span><span class="nx">iframeDocument</span><span class="p">().</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mousemove touchmove&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_drag</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseup touchend&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_stopDrag</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span>
            <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>This can fail if the frame is in another domain</p></div></div><div class="code"><div class="wrapper">            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_parentRect</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">clientRect</span><span class="p">();</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_isDragging</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_drag</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>

        <span class="kd">var</span> <span class="nx">mousePos</span> <span class="o">=</span> <span class="nx">getMousePos</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">deltaTop</span> <span class="o">=</span> <span class="nx">mousePos</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">_initialMousePos</span><span class="p">.</span><span class="nx">top</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">deltaLeft</span> <span class="o">=</span> <span class="nx">mousePos</span><span class="p">.</span><span class="nx">left</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">_initialMousePos</span><span class="p">.</span><span class="nx">left</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">newPos</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">top</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_initialDialogPos</span><span class="p">.</span><span class="nx">top</span> <span class="o">+</span> <span class="nx">deltaTop</span><span class="p">,</span>
            <span class="nx">left</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_initialDialogPos</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">deltaLeft</span>
        <span class="p">};</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="nx">newPos</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_stopDrag</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_initialMousePos</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_initialDialogPos</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

        <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Remove the drag events</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s2">&quot;mousemove touchmove&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_drag</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s2">&quot;mouseup touchend&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_stopDrag</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s2">&quot;mouseup touchend&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_stopDrag</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$frame</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">$frame</span><span class="p">.</span><span class="nx">iframeDocument</span><span class="p">().</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s2">&quot;mousemove touchmove&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_drag</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s2">&quot;mouseup touchend&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_stopDrag</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_isDragging</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Gets the current mouse position from the event object.
returns an object with top and left</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">getMousePos</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">touches</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">.</span><span class="nx">touches</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">touches</span> <span class="o">&amp;&amp;</span> <span class="nx">touches</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">e</span> <span class="o">=</span> <span class="nx">touches</span><span class="p">.</span><span class="nx">item</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> 
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">mousePos</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">left</span><span class="o">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span><span class="p">,</span>
            <span class="nx">top</span><span class="o">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span>
        <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Translate event positions from a nested iframe</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">ownerDocument</span> <span class="o">!=</span> <span class="nb">window</span><span class="p">.</span><span class="nb">document</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">$iframe</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">ownerDocument</span><span class="p">).</span><span class="nx">hostIframe</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">$iframe</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">rect</span> <span class="o">=</span> <span class="nx">$iframe</span><span class="p">.</span><span class="nx">clientRect</span><span class="p">();</span>
                <span class="nx">mousePos</span><span class="p">.</span><span class="nx">top</span> <span class="o">+=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">top</span><span class="p">;</span>
                <span class="nx">mousePos</span><span class="p">.</span><span class="nx">left</span> <span class="o">+=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">left</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">mousePos</span><span class="p">;</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Builds the DOM for the content node.
Should be overridden by subclasses.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_buildContent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$content</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">content</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$content</span><span class="p">.</span><span class="nx">detach</span><span class="p">();</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Gets a reference to the current window.
This will be overriden by an iframe dialog.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getWindow</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">window</span><span class="p">;</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Gets a reference to the dialog that opened this dialog.
This is null if the dialog was opened by the main window.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getParent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">parentId</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nx">getDialog</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">parentId</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Sets the height of the content in pixels.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">center</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getDefaultPosition</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">[</span><span class="nx">_animateMethod</span><span class="p">]({</span> <span class="nx">top</span><span class="o">:</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">top</span> <span class="p">},</span> <span class="mi">400</span><span class="p">);</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Reposition the dialog to the correct position.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pos</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">animate</span><span class="p">)</span>
    <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>stop any currently running animations</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>

        <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getDefaultPosition</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">animate</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">top</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">top</span><span class="p">;</span>
            <span class="k">delete</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">top</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="nx">pos</span><span class="p">)[</span><span class="nx">_animateMethod</span><span class="p">]({</span> <span class="nx">top</span><span class="o">:</span> <span class="nx">top</span> <span class="p">},</span> <span class="mi">400</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="nx">pos</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Sets the title of the dialog in the header.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setTitle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.dialog-header h1&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">title</span><span class="p">);</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Extends ModalDialog such that the content is an iframe.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">FramedModalDialog</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">parentId</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_parentWindow</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">frames</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">parentId</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">FramedModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>

    <span class="nx">FramedModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">dialogType</span> <span class="o">=</span> <span class="s2">&quot;iframe&quot;</span><span class="p">;</span>

    <span class="nx">FramedModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_setupCustomEvent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">evt</span> <span class="o">=</span> <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_setupCustomEvent</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
        <span class="nx">evt</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">_crossWindowEventHandler</span><span class="p">);</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Broadcasts events to all active dialogs so any window that has a proxy for the dialog can be notified.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">_crossWindowEventHandler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
    <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>"this" is the dialog</p></div></div><div class="code"><div class="wrapper">        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">_dialogStack</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">_dialogStack</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_postCommand</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nx">_dialogStack</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_postCommand</span><span class="p">(</span><span class="s2">&quot;event&quot;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span> <span class="nx">_eventDialogId</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">_fullId</span><span class="p">},</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Override the _buildContent method to construct an iframe</p></div></div><div class="code"><div class="wrapper">    <span class="nx">FramedModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_finishClose</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_finishClose</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">$frame</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
    <span class="p">};</span>

    <span class="nx">FramedModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_destroy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Override the _buildContent method to construct an iframe</p></div></div><div class="code"><div class="wrapper">    <span class="nx">FramedModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_buildContent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="cm">/* jshint quotmark:false */</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">$frame</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;iframe src=&quot;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">url</span> <span class="o">+</span> <span class="s1">&#39;&quot; name=&quot;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">_fullId</span> <span class="o">+</span> <span class="s1">&#39;&quot; seamless allowtransparency=&quot;true&quot; width=&quot;100%&quot; style=&quot;height:&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">initialHeight</span> <span class="o">+</span> <span class="s1">&#39;px;&quot; class=&quot;dialog-frame&quot; scrolling=&quot;no&quot; frameborder=&quot;0&quot; framespacing=&quot;0&quot; /&gt;&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$content</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$frame</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="nx">FramedModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_alreadyBuilt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_buildContent</span><span class="p">();</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">$contentContainer</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$content</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="nx">FramedModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getWindow</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">$frame</span><span class="p">.</span><span class="nx">iframeWindow</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Sends a message to the iframe content window. 
Used for orchestrating cross-window communication with dialog proxies.
* {string} command: The name of the command to send to the content window
* {object} data: A simple data object to serialize (as a querystring) and send with the command</p></div></div><div class="code"><div class="wrapper">    <span class="nx">FramedModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_postCommand</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">command</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">messageData</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">dialogCmd</span><span class="o">:</span> <span class="nx">command</span> <span class="p">};</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">messageData</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="nx">messageData</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Sends a message to the iframe content window. 
Used for orchestrating cross-window communication with dialog proxies.
* {string} command: The name of the command to send to the content window
* {object} data: A simple data object to serialize (as a querystring) and send with the command</p></div></div><div class="code"><div class="wrapper">    <span class="nx">FramedModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">postMessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">win</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getWindow</span><span class="p">();</span>

        <span class="kd">var</span> <span class="nx">hostname</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">frameHostname</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hostname</span><span class="p">)</span>
        <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get the domain of the target window. If the URL is relative, its the same as the current page.</p></div></div><div class="code"><div class="wrapper">            <span class="nx">hostname</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">url</span> <span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">hostname</span><span class="p">,</span> <span class="nx">win</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="nx">win</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="nx">FramedModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setHeight</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">contentHeight</span><span class="p">,</span> <span class="nx">center</span><span class="p">,</span> <span class="nx">skipAnimation</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">applyChange</span> <span class="o">=</span> <span class="nx">skipAnimation</span> <span class="o">?</span> 
            <span class="kd">function</span><span class="p">(</span><span class="nx">$content</span><span class="p">,</span> <span class="nx">css</span><span class="p">)</span> <span class="p">{</span> <span class="nx">$content</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="nx">css</span><span class="p">);</span> <span class="p">}</span> <span class="o">:</span>
            <span class="kd">function</span><span class="p">(</span><span class="nx">$content</span><span class="p">,</span> <span class="nx">css</span><span class="p">)</span> <span class="p">{</span> <span class="nx">$content</span><span class="p">.</span><span class="nx">animate</span><span class="p">(</span><span class="nx">css</span><span class="p">,</span> <span class="p">{</span> <span class="nx">duration</span><span class="o">:</span> <span class="mi">400</span> <span class="p">});</span> <span class="p">};</span>

        <span class="nx">applyChange</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$content</span><span class="p">,</span> <span class="p">{</span> <span class="nx">height</span><span class="o">:</span> <span class="nx">contentHeight</span> <span class="p">});</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">center</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getDefaultPosition</span><span class="p">(</span><span class="nx">contentHeight</span><span class="p">);</span>
            <span class="nx">applyChange</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$content</span><span class="p">,</span> <span class="p">{</span> <span class="nx">top</span><span class="o">:</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">top</span> <span class="p">});</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">initialHeight</span> <span class="o">=</span> <span class="nx">contentHeight</span><span class="p">;</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Sets the height of the iframe to the detected height of the iframe content document.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">FramedModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setHeightFromContent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">center</span><span class="p">,</span> <span class="nx">skipAnimation</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_postCommand</span><span class="p">(</span><span class="s2">&quot;setHeightFromContent&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">center</span><span class="o">:</span> <span class="o">!!</span><span class="nx">center</span><span class="p">,</span> <span class="nx">skipAnimation</span><span class="o">:</span> <span class="o">!!</span><span class="nx">skipAnimation</span><span class="p">});</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Sets the title of the dialog in the header from the HTML title tag of the iframe content document.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">FramedModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setTitleFromContent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_postCommand</span><span class="p">(</span><span class="s2">&quot;setTitleFromContent&quot;</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="nx">FramedModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">notifyReady</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">hostname</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">frameHostname</span> <span class="o">=</span> <span class="nx">hostname</span><span class="p">;</span>

        <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_finishOpen</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="nx">FramedModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_finishOpen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>AjaxModalDialog: Extends ModalDialog 
Loads content via ajax</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">AjaxModalDialog</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">AjaxModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>

    <span class="nx">AjaxModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">dialogType</span> <span class="o">=</span> <span class="s2">&quot;ajax&quot;</span><span class="p">;</span>

    <span class="nx">AjaxModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">open</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">open</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_ajaxComplete</span><span class="p">)</span>
        <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>$.fn.partialLoad will ajax in content intelligently,
adding scripts, but not if they're already loaded.</p></div></div><div class="code"><div class="wrapper">            <span class="k">this</span><span class="p">.</span><span class="nx">$content</span><span class="p">.</span><span class="nx">partialLoad</span><span class="p">(</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span>
                <span class="kc">null</span><span class="p">,</span>
                <span class="nx">$</span><span class="p">.</span><span class="nx">proxy</span><span class="p">(</span>
                    <span class="kd">function</span><span class="p">(</span><span class="nx">responseText</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">_ajaxComplete</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="kd">var</span> <span class="nx">isError</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

                        <span class="nx">xhr</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span>
                        <span class="p">{</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">onajaxerror</span><span class="p">.</span><span class="nx">fire</span><span class="p">({</span> 
                                <span class="nx">xhr</span><span class="o">:</span> <span class="nx">xhr</span><span class="p">,</span> 
                                <span class="nx">status</span><span class="o">:</span> <span class="nx">status</span><span class="p">,</span> 
                                <span class="nx">responseText</span><span class="o">:</span> <span class="nx">responseText</span>
                            <span class="p">});</span>

                            <span class="nx">isError</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="p">});</span>

                        <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_finishOpen</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
                    <span class="p">},</span> 
                    <span class="k">this</span><span class="p">)</span>
                <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The content is already loaded</p></div></div><div class="code"><div class="wrapper">            <span class="nx">ModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_finishOpen</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="nx">AjaxModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_finishOpen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>no-op. Needds to wait for content to be ajaxed in asynchronously.
Base implementation will be called manually.</p></div></div><div class="code"><div class="wrapper">    <span class="p">};</span>

    <span class="nx">AjaxModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_buildContent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create a container and ajax content into it.</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">$content</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;div class=&#39;dialog-content&#39;&gt;&lt;/div&gt;&quot;</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="nx">AjaxModalDialog</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_destroy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">_dialogIdCounter</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">DIALOG_NAME_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;dialog&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Determines if the specified string is a CSS selector or a URL.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">isSelector</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">firstChar</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">firstChar</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">)</span>
        <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>This is a #anchor
Its a selector</p></div></div><div class="code"><div class="wrapper">            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Selectors never contain /
This is a URL</p></div></div><div class="code"><div class="wrapper">            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">firstChar</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">secondChar</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">secondChar</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span> <span class="o">||</span> <span class="nx">secondChar</span> <span class="o">==</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Starts with .. or ./
This is a URL, not a selector</p></div></div><div class="code"><div class="wrapper">                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>It's a CSS class:
.foo</p></div></div><div class="code"><div class="wrapper">            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>We can't determine. Presume this is a URL.
i.e. "something" or "something.something" can be a either URL or a selector</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="c1">//Takes a settings object and calculates derived settings.</span>
    <span class="c1">//Settings go in order:</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>default value</li>
<li>setting provided on content element</li>
<li>settings passed</li>
</ol></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">ensureSettings</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">explicitSettings</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">settings</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">_defaults</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>An iframe dialog may have sent a reference to dialog content,
but it didn't know if it was a URL or a selector for a DOM node.
Determine which it is.</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">explicitSettings</span><span class="p">.</span><span class="nx">contentOrUrl</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">isSelector</span><span class="p">(</span><span class="nx">explicitSettings</span><span class="p">.</span><span class="nx">contentOrUrl</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="nx">explicitSettings</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">explicitSettings</span><span class="p">.</span><span class="nx">contentOrUrl</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="nx">explicitSettings</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">explicitSettings</span><span class="p">.</span><span class="nx">contentOrUrl</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">delete</span> <span class="nx">explicitSettings</span><span class="p">.</span><span class="nx">contentOrUrl</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Read settings specified on the target node's custom HTML attributes</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">explicitSettings</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">$target</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">explicitSettings</span><span class="p">.</span><span class="nx">content</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">targetSettings</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">getSettings</span><span class="p">(</span><span class="nx">$target</span><span class="p">);</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">settings</span><span class="p">,</span> <span class="nx">targetSettings</span><span class="p">);</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The explicitly specified settings take precedence</p></div></div><div class="code"><div class="wrapper">        <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">settings</span><span class="p">,</span> <span class="nx">explicitSettings</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">id</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A fullId was specified, passed from an existing dialog's content window via a message. 
Calculate the parentId from the fullId.</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">_fullId</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">idParts</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">_fullId</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">);</span>
            <span class="nx">id</span> <span class="o">=</span> <span class="nx">idParts</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">idParts</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nx">settings</span><span class="p">.</span><span class="nx">parentId</span> <span class="o">=</span> <span class="nx">idParts</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Ensure a unique ID for the dialog</p></div></div><div class="code"><div class="wrapper">            <span class="nx">id</span> <span class="o">=</span> <span class="nx">DIALOG_NAME_PREFIX</span> <span class="o">+</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">id</span> <span class="o">||</span> <span class="o">++</span><span class="nx">_dialogIdCounter</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If a parentId was specified, this is a new dialog being created from 
a child dialog. The child will become the "parent dialog" of the new dialog.</p></div></div><div class="code"><div class="wrapper">            <span class="kd">var</span> <span class="nx">parentId</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">parentId</span> <span class="o">?</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">parentId</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

            <span class="nx">settings</span><span class="p">.</span><span class="nx">_fullId</span> <span class="o">=</span> <span class="nx">parentId</span> <span class="o">+</span> <span class="nx">id</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">settings</span><span class="p">;</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Gets the dialog by the fullId.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>{string} fullId The full ID of the dialog (including all parent ids)</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">getDialog</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fullId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nx">_fullIdMap</span><span class="p">[</span><span class="nx">fullId</span><span class="p">];</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Public sub-namespace for modal dialogs.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span> <span class="o">||</span> <span class="p">{};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Used to prevent the content window script from loading over this one</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">_isHost</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>On small screens we make the background opaque to hide the content because
we will be hiding all content within the DOM and scrolling them to top.
When removing the host window content from the DOM, make the veil opaque to hide it.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">veilClass</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">isSmallScreen</span><span class="p">()</span> <span class="o">?</span> <span class="s2">&quot;dialog-veil-opaque&quot;</span> <span class="o">:</span> <span class="s2">&quot;dialog-veil&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Creates a new dialog from the specified settings.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">create</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">settings</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">settings</span> <span class="o">=</span> <span class="nx">ensureSettings</span><span class="p">(</span><span class="nx">settings</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">dialog</span> <span class="o">=</span> <span class="nx">getDialog</span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">_fullId</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dialog</span> <span class="o">&amp;&amp;</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">dialog</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">content</span><span class="p">).</span><span class="nx">modalDialogInstance</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">dialog</span> <span class="o">&amp;&amp;</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">_fullId</span> <span class="o">&amp;&amp;</span> <span class="nx">dialog</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">_fullId</span> <span class="o">!==</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">_fullId</span> <span class="o">&amp;&amp;</span> <span class="nx">dialog</span><span class="p">.</span><span class="nx">_open</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;An attempt was made to create a dialog with a content node which is already assigned to another open dialog.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dialog</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Both url and content cannot be specified.&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">ajax</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="nx">dialog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AjaxModalDialog</span><span class="p">(</span><span class="nx">settings</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="nx">dialog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FramedModalDialog</span><span class="p">(</span><span class="nx">settings</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nx">dialog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ModalDialog</span><span class="p">(</span><span class="nx">settings</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">settings</span><span class="p">.</span><span class="nx">destroyOnClose</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="nx">$</span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">content</span><span class="p">).</span><span class="nx">modalDialogInstance</span><span class="p">(</span><span class="nx">dialog</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;No url or content node specified&quot;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="nx">_fullIdMap</span><span class="p">[</span><span class="nx">settings</span><span class="p">.</span><span class="nx">_fullId</span><span class="p">]</span> <span class="o">=</span> <span class="nx">dialog</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">dialog</span><span class="p">;</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Gets the currently active dialog (topmost visually).</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">getCurrent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nx">_dialogStack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">_dialogStack</span><span class="p">[</span><span class="nx">_dialogStack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Global events (not associated with an instance)</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">.</span><span class="nx">CustomEvent</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">,</span> <span class="s2">&quot;beforeopen&quot;</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">CustomEvent</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">,</span> <span class="s2">&quot;open&quot;</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">CustomEvent</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">,</span> <span class="s2">&quot;beforeclose&quot;</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">CustomEvent</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">,</span> <span class="s2">&quot;close&quot;</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">JQUERY_DATA_KEY</span> <span class="o">=</span> <span class="s2">&quot;modalDialog&quot;</span><span class="p">;</span>

    <span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">modalDialogInstance</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dialog</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="o">!</span><span class="nx">dialog</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">JQUERY_DATA_KEY</span><span class="p">)</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">JQUERY_DATA_KEY</span><span class="p">,</span> <span class="nx">dialog</span><span class="p">);</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Idiomatic jQuery interface for node dialogs.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">modalDialog</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">settings</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">dialog</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If the first argument is a string, it is a method name to call on the dialog
associated with the DOM element.</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">settings</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">action</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">;</span>
            <span class="nx">dialog</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">modalDialogInstance</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">dialog</span> <span class="o">&amp;&amp;</span> <span class="nx">dialog</span><span class="p">[</span><span class="nx">action</span><span class="p">])</span>
            <span class="p">{</span>
                <span class="nx">dialog</span><span class="p">[</span><span class="nx">action</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">dialog</span><span class="p">,</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Otherwise, create a new dialog.</p></div></div><div class="code"><div class="wrapper">        <span class="k">else</span>
        <span class="p">{</span>
            <span class="nx">settings</span> <span class="o">=</span> <span class="nx">settings</span> <span class="o">||</span> <span class="p">{};</span>
            <span class="nx">settings</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

            <span class="nx">dialog</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">settings</span><span class="p">);</span>

            <span class="nx">dialog</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A map of actions that can be passed as the "dialogCmd" argument in posted messages from FramedModalDialog dialog proxies.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">messageActions</span> <span class="o">=</span> 
    <span class="p">{</span>
        <span class="nx">setHeight</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dialog</span><span class="p">,</span> <span class="nx">qs</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">dialog</span><span class="p">.</span><span class="nx">setHeight</span><span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">qs</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">center</span> <span class="o">===</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">skipAnimation</span> <span class="o">===</span> <span class="s2">&quot;true&quot;</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">setTitle</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dialog</span><span class="p">,</span> <span class="nx">qs</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">dialog</span><span class="p">.</span><span class="nx">setTitle</span><span class="p">(</span><span class="nx">qs</span><span class="p">.</span><span class="nx">title</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">open</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dialog</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">dialog</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span>
        <span class="p">},</span>

        <span class="nx">close</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dialog</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">dialog</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
        <span class="p">},</span>

        <span class="nx">create</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span>
        <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>do nothing- the dialog was created already</p></div></div><div class="code"><div class="wrapper">        <span class="p">},</span>

        <span class="nx">center</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dialog</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">dialog</span><span class="p">.</span><span class="nx">center</span><span class="p">();</span>
        <span class="p">},</span>

        <span class="nx">notifyReady</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dialog</span><span class="p">,</span> <span class="nx">qs</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">dialog</span><span class="p">.</span><span class="nx">notifyReady</span><span class="p">(</span><span class="nx">qs</span><span class="p">.</span><span class="nx">hostname</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">messageHandler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">qs</span><span class="p">;</span>

        <span class="k">try</span>
        <span class="p">{</span>
            <span class="nx">qs</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">deparam</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">originalEvent</span> <span class="o">?</span> <span class="nx">e</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">.</span><span class="nx">data</span> <span class="o">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span>
        <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>ignore- it wasn't a message for the dialog framework</p></div></div><div class="code"><div class="wrapper">        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>messages in the dialog framework contain "dialogCmd"</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">qs</span> <span class="o">&amp;&amp;</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">dialogCmd</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">action</span> <span class="o">=</span> <span class="nx">messageActions</span><span class="p">[</span><span class="nx">qs</span><span class="p">.</span><span class="nx">dialogCmd</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">action</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">dialog</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">qs</span><span class="p">.</span><span class="nx">_fullId</span><span class="p">)</span>
                <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If a fullId is passed, it can be either for a new dialog or an existing dialog.
$.modalDialog.create() handles both cases.</p></div></div><div class="code"><div class="wrapper">                    <span class="nx">dialog</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">qs</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="nx">dialog</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">modalDialog</span><span class="p">.</span><span class="nx">getCurrent</span><span class="p">();</span>
                <span class="p">}</span>

                <span class="nx">action</span><span class="p">(</span><span class="nx">dialog</span><span class="p">,</span> <span class="nx">qs</span><span class="p">);</span>

                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Note: It is a bit odd that even though we have the jquery.postMessage() plugin,
we're still checking its availability and calling the native implementation here.
The reason is that for most browsers (besides old IE) the plugin is unnecessary, 
and it may not be desirable to load it at all.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">receiveMessage</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">receiveMessage</span><span class="p">(</span><span class="nx">messageHandler</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="nx">messageHandler</span><span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Global hook to simplify non-cross domain communication</p></div></div><div class="code"><div class="wrapper">    <span class="nb">window</span><span class="p">.</span><span class="nx">_dialogReceiveMessageManual</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">origin</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">messageHandler</span><span class="p">({</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">origin</span><span class="o">:</span> <span class="nx">origin</span><span class="p">}))</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">evt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Event</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">);</span>
            <span class="nx">evt</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">message</span><span class="p">;</span>
            <span class="nx">evt</span><span class="p">.</span><span class="nx">origin</span> <span class="o">=</span> <span class="nx">origin</span><span class="p">;</span>
            <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">evt</span><span class="p">,</span> <span class="p">[</span><span class="nx">message</span><span class="p">,</span> <span class="nx">origin</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>jQuery mobile support</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">$</span><span class="p">.</span><span class="nx">mobile</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Alternate defaults when jQuery mobile is loaded. Work around JQM's quirks.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">_defaults</span> <span class="o">=</span>  <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span>
            <span class="nx">_defaults</span><span class="p">,</span>
            <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>JQM widgets must be in the active data-role="page" element to work
containerElement: ".ui-page.ui-page-active",</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Event bubbling breaks many JQM widgets</p></div></div><div class="code"><div class="wrapper">                <span class="nx">preventEventBubbling</span><span class="o">:</span> <span class="kc">false</span>
            <span class="p">});</span>
    <span class="p">});</span>

<span class="p">})(</span><span class="nx">jQuery</span><span class="p">);</span></div></div></div></div></body></html>