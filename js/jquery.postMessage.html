<!DOCTYPE html><html lang="en"><head><title>js\jquery.postMessage</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="js\jquery.postMessage"><meta name="groc-project-path" content="js\jquery.postMessage.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">js\jquery.postMessage.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="cm">/* globals Window */</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><a href="../index.html">Homepage</a> | 
<a href="https://github.com/vistaprint/SkinnyJS/blob/master/js/jquery.postMessage.js" target="_blank">View this file on Github</a> | 
<a href="https://raw.github.com/vistaprint/SkinnyJS/master/js/jquery.postMessage.js" target="_blank">Download this file</a>

<hr style="height: 1px; border:0; background-color:#4A525A">
<h2 id="jquery-postmessage-plugin">jQuery postMessage plugin</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Wraps HTML5 postMessage for cross-origin message sending between windows.
Fallback implementation works on browsers that don't support postMessage.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Based on concepts from: <a href="http://benalman.com/projects/jquery-postmessage-plugin/">http://benalman.com/projects/jquery-postmessage-plugin/</a>
Improved for non-awesome browsers by using iframes for communication instead of <br />
url fragments and polling. This technique eliminates race conditions where messages sent
in rapid succession might not be received. It also removes the need for polling.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Supports almost any conceivable browser, tested with IE6+</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="usage">Usage</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="polyfill-setup">Polyfill setup</h4></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>To support IE6-7 (and IE8-10 for non-frame windows), you need to make the polyfill HTML file (postmessage.htm) available on your web server.
For example, you could put the file here:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>http://www.mysite.com/scripts/thirdparty/skinnyjs/postmessage.htm
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>IMPORTANT: This file must be on the same domain as the content you want to communicate with. It cannot be hosted on a different domain (i.e. Google CDN).</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Once the file is available, you need to configure the postMessage plugin to point to it. Add this line anywhere on your page (or as the first/last line of jquery.postMessage.js):</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>window._jqueryPostMessagePolyfillPath = "/scripts/thirdparty/skinnyjs/postmessage.htm";
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="sending-a-message-to-another-window">Sending a message to another window</h4></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>$.postMessage() has the following signature:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>$.postMessage(
    message, // The message to send (string)
    targetHost, // The host of the target window (i.e. http://www.vistaprint.com)
    targetWindow // A reference to the target window
    );
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Note that the $.postMessage() API is slightly different from the HTML5 standard window.postMessage(),
in that it requires explicitly specifying the domain of the target window. This is necessary because there's
no way to determine the target window's domain programatically, and the domain is required for the
polyfill technique to work.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Example usage:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>$.postMessage(
    "this is a message",
    "http://www.foo.com",
    window.frames["fooWindow"]
    );
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="listening-to-messages-from-another-window">Listening to messages from another window</h4></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>To listen for messages from another window, use jQuery's built in event handling infrastructure and listen for "message" events on the window object:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>This example simply alerts every message it receives, from any origin:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>$(window).on("message", function(e) {
    alert(e.data); // Alerts "this is a message"
});
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>In general, its a good idea to filter out requests from unknown domains. This example filters messages not from http://www.foo.com:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>$(window).on("message", function(e) {
        if (e.origin !== "http://www.foo.com")
        {
            return;
        }
        alert(e.data); // Alerts "this is a message"
    });
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>This example alerts every message it receives, from any subdomain of foo.com:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>$(window).on("message", function(e) {
        if (origin.search(/http:\/\/[^\.]*\.foo\.com$/gi) &lt; 0)
        {
            return;
        }
        alert(e.data); // Alerts "this is a message"
    });
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Its also a common practice to "namespace" messages so your handlers don't respond to messages they don't know how to handle:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>$(window).on("message", function(e) {
        if (e.origin !== "http://www.foo.com")
        {
            return;
        }

        if (e.data.indexOf("fruit:") !== 0)
        {
            return;
        }

        // TODO: Remove the "fruit:" namespace and do something with the message
    });
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="source">Source</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="nx">$</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cacheBuster</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">browserSupportsPostMessage</span> <span class="o">=</span> <span class="o">!!</span><span class="nb">window</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Given a URL, returns the domain portion (i.e. http://www.somedomain.com)</p></div></div><div class="code"><div class="wrapper">    <span class="kd">function</span> <span class="nx">getDomainFromUrl</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="k">return</span> <span class="nx">url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^:]+:\/\/[^\/]+).*/</span><span class="p">,</span> <span class="s2">&quot;$1&quot;</span><span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Given a domain pattern (i.e. http://somedomain.com) matches against a specified domain</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>{String or Function} originPatternOrFunction: A pattern or a function to match against sourceOrigin</li>
<li>{String} sourceOrigin: The string to match using the originPatternOrFunction</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="kd">function</span> <span class="nx">isOriginMatch</span><span class="p">(</span><span class="nx">originPatternOrFunction</span><span class="p">,</span> <span class="nx">sourceOrigin</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">originPatternOrFunction</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span> <span class="o">&amp;&amp;</span> 
            <span class="nx">sourceOrigin</span> <span class="o">!==</span> <span class="nx">originPatternOrFunction</span> <span class="o">&amp;&amp;</span> 
            <span class="nx">originPatternOrFunction</span> <span class="o">!==</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">originPatternOrFunction</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
            <span class="o">!</span><span class="nx">originPatternOrFunction</span><span class="p">(</span><span class="nx">sourceOrigin</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Try to find the relationship between the current window
and a provided window reference.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>{Window} window: Current window or window sending event.</li>
<li>{Window} target: Target window</li>
<li>{number} level: Do not pass originally. Used only by recursion.</li>
</ul></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Will return a short reference string or false if cannot be found.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">function</span> <span class="nx">transverseLevel</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">level</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">level</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Try to find the target in window.frames</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">frames</span><span class="p">)</span> 
        <span class="p">{</span>
            <span class="k">try</span> 
            <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nb">window</span><span class="p">.</span><span class="nx">frames</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> 
                <span class="p">{</span>
                    <span class="k">try</span> 
                    <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">frames</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">target</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="k">return</span> <span class="s2">&quot;f,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span> 
                    <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> 
                    <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">number</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">2147024891</span><span class="p">)</span> <span class="c1">// WTF is this?</span>
                        <span class="p">{</span>
                            <span class="k">throw</span> <span class="nx">e</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span> 
            <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> 
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">ex</span><span class="p">.</span><span class="nx">number</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">2146823279</span><span class="p">)</span> <span class="c1">// and, WTF is this?</span>
                <span class="p">{</span>
                    <span class="k">throw</span> <span class="nx">ex</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Try to find the target in window.parent</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">parent</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">parent</span> <span class="o">===</span> <span class="nx">target</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="s2">&quot;p&quot;</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Try to find the target in window.opener</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">opener</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">opener</span> <span class="o">===</span> <span class="nx">target</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="s2">&quot;o&quot;</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prevent infinite recursion. 
There's really no good reason you need 4 levels deep of frames!</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">level</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> 
        <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">ref</span><span class="p">;</span>
        </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Recurse through window.frames</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">frames</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">frames</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> 
        <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">frames</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> 
            <span class="p">{</span>
                <span class="nx">ref</span> <span class="o">=</span> <span class="nx">transverseLevel</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">frames</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">ref</span><span class="p">)</span> 
                <span class="p">{</span>
                    <span class="k">return</span> <span class="s2">&quot;f,&quot;</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nx">ref</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Recurse through window.parent</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">parent</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">parent</span> <span class="o">!==</span> <span class="nb">window</span><span class="p">)</span> 
        <span class="p">{</span>
            <span class="nx">ref</span> <span class="o">=</span> <span class="nx">transverseLevel</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">ref</span><span class="p">)</span> 
            <span class="p">{</span>
                <span class="k">return</span> <span class="s2">&quot;p.&quot;</span> <span class="o">+</span> <span class="nx">ref</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Recurse through window.opener</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">opener</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">opener</span> <span class="o">!==</span> <span class="nb">window</span><span class="p">)</span> 
        <span class="p">{</span>
            <span class="nx">ref</span> <span class="o">=</span> <span class="nx">transverseLevel</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">opener</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">ref</span><span class="p">)</span> 
            <span class="p">{</span>
                <span class="k">return</span> <span class="s2">&quot;o&quot;</span> <span class="o">+</span> <span class="nx">ref</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>Find the relationship between current and target window.</li>
<li>Serialize a string path from the current to the target window.
Example: f,0.f,0 translates to window.frames[0].frames[0]
Example: p.p translates to window.parent.parent</li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>{Window} currentWindow: Starting window</li>
<li>{Window|string} targetWindow: Window to determine reference to.</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="kd">function</span> <span class="nx">serializeWindowReference</span><span class="p">(</span><span class="nx">currentWindow</span><span class="p">,</span> <span class="nx">targetWindow</span><span class="p">)</span> 
    <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If the target window was opened with window.open(), its name is the only
way to get to it. This makes for a yucky API, unfortunately.</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="p">(</span><span class="nx">targetWindow</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nx">targetWindow</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>first see if we can quickly find the reference</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">currentWindow</span> <span class="o">===</span> <span class="nx">targetWindow</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Trying to postMessage to self. Pointlessly useless.&quot;</span><span class="p">);</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>see if the target is simple the parent</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">currentWindow</span><span class="p">.</span><span class="nx">parent</span> <span class="o">&amp;&amp;</span> <span class="nx">currentWindow</span><span class="p">.</span><span class="nx">parent</span> <span class="o">!==</span> <span class="nx">currentWindow</span> <span class="o">&amp;&amp;</span> <span class="nx">currentWindow</span><span class="p">.</span><span class="nx">parent</span> <span class="o">===</span> <span class="nx">targetWindow</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="s2">&quot;p&quot;</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>see if the target is simply the opener</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">currentWindow</span><span class="p">.</span><span class="nx">opener</span> <span class="o">&amp;&amp;</span> <span class="nx">currentWindow</span><span class="p">.</span><span class="nx">opener</span> <span class="o">!==</span> <span class="nx">currentWindow</span> <span class="o">&amp;&amp;</span> <span class="nx">currentWindow</span><span class="p">.</span><span class="nx">opener</span> <span class="o">===</span> <span class="nx">targetWindow</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="s2">&quot;o&quot;</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Try to determine the relationship through recursion.</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">ref</span> <span class="o">=</span> <span class="nx">transverseLevel</span><span class="p">(</span><span class="nx">currentWindow</span><span class="p">,</span> <span class="nx">targetWindow</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ref</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nx">ref</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t serialize window reference&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Sends a message to a window in a different domain.
* {String} message: The message to send
* {String} targetHost: The domain of the window to which the message should be sent
                              (i.e. http://www.something.com)
* {Window} targetWindow: A reference to the target window to which the message should be sent
* {string} targetWindowName: If the target window is a child window (not a frame), the window name
                              is required for browsers that don"t support postMessage() natively.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">.</span><span class="nx">postMessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">targetHost</span><span class="p">,</span> <span class="nx">targetWindow</span><span class="p">,</span> <span class="cm">/* optional */</span> <span class="nx">targetWindowName</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">targetHost</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;targetHost argument was not supplied to jQuery.postMessage&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">targetWindow</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;No targetWindow specified&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">targetHost</span> <span class="o">=</span> <span class="nx">getDomainFromUrl</span><span class="p">(</span><span class="nx">targetHost</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>native works for:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>Opera 12.12 (build 1707, x64, Win7)</li>
<li>Chrome 24.0.1312.56 m (Win7)</li>
<li>Firefox 18.0.1 (Win7)</li>
</ul></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">browserSupportsPostMessage</span><span class="p">)</span> 
        <span class="p">{</span>
            <span class="k">try</span> 
            <span class="p">{</span>
                <span class="nx">targetWindow</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">targetHost</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> 
            <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>In IE (all known versions), postMessage() works only for iframes within the same
top-level window, and will fail with "No such interface supported" for calls between top-level windows.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li><a href="http://blogs.msdn.com/b/ieinternals/archive/2009/09/16/bugs-in-ie8-support-for-html5-postmessage-sessionstorage-and-localstorage.aspx">http://blogs.msdn.com/b/ieinternals/archive/2009/09/16/bugs-in-ie8-support-for-html5-postmessage-sessionstorage-and-localstorage.aspx</a></li>
<li><a href="http://blogs.msdn.com/b/thebeebs/archive/2011/12/21/postmessage-popups-and-ie.aspx">http://blogs.msdn.com/b/thebeebs/archive/2011/12/21/postmessage-popups-and-ie.aspx</a></li>
</ul></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>No such interface supported. Fall through to the polyfill technique.</p></div></div><div class="code"><div class="wrapper">                <span class="k">if</span> <span class="p">(</span><span class="nx">ex</span><span class="p">.</span><span class="nx">number</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">2147467262</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">throw</span> <span class="nx">ex</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The browser does not support window.postMessage.
First, lets see if we can get direct access to the window instead.
This will only work if the target window is in the same domain.</p></div></div><div class="code"><div class="wrapper">        <span class="k">try</span>
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">postMessageDirect</span> <span class="o">=</span> <span class="nx">targetWindow</span><span class="p">.</span><span class="nx">__receiveMessageHook</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">postMessageDirect</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nx">postMessageDirect</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">targetHost</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Direct access wont work because the targetWindow is in a different domain.
Create an iframe in the same domain as the target window and use it as a proxy to talk
to the target window. Pass the proxy information in an encoded URL fragment,
(not a querystring, which would cause it to load from the server)</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">serializedWindowRef</span> <span class="o">=</span> <span class="nx">serializeWindowReference</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="nx">targetWindowName</span> <span class="o">||</span> <span class="nx">targetWindow</span><span class="p">),</span>
            <span class="nx">thisDomain</span> <span class="o">=</span> <span class="nx">getDomainFromUrl</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">),</span>
            <span class="nx">iframe</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;iframe&quot;</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">targetHost</span> <span class="o">||</span> <span class="nx">targetHost</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;$.postMessage(): Must specify targetHost on browsers that don&#39;t support postMessage natively (cannot be &#39;*&#39;).&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">iframe</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">hide</span><span class="p">()</span>
            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="nx">targetHost</span> <span class="o">+</span> <span class="nx">getPolyfillPath</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>When server side debugging, add (+new Date()) here</p></div></div><div class="code"><div class="wrapper">                <span class="p">(</span><span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">())</span> <span class="o">+</span> <span class="nx">cacheBuster</span> <span class="o">+</span> <span class="s2">&quot;&amp;&quot;</span> <span class="o">+</span>
                <span class="nx">serializedWindowRef</span> <span class="o">+</span> <span class="s2">&quot;&amp;&quot;</span> <span class="o">+</span> <span class="nx">thisDomain</span> <span class="o">+</span> <span class="s2">&quot;&amp;&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>remove this DOM iframe once it is no longer needed</p></div></div><div class="code"><div class="wrapper">                <span class="nx">$</span><span class="p">(</span><span class="nx">iframe</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
            <span class="p">})</span>
        <span class="p">);</span>

        <span class="nx">cacheBuster</span><span class="o">++</span><span class="p">;</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Assigns an event handler (callback) to receive messages sent to the window, from the specified origin.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>{function(Object)} callback: The event handler function to call when a message is received</li>
<li>{string|function(string)} allowedOriginOrFunction: Either a domain string (i.e. http://www.something.com),
                                                a wildcard (i.e. "*"), or a function that takes domain
                                                strings and returns true or false.</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">.</span><span class="nx">receiveMessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">allowedOriginOrFunction</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">callback</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;No callback function specified&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">allowedOriginOrFunction</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">allowedOriginOrFunction</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">origin</span><span class="p">)</span> 
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">)</span> 
            <span class="p">{</span>
                <span class="nx">data</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">originalEvent</span> <span class="o">?</span> <span class="nx">event</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">.</span><span class="nx">data</span> <span class="o">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">origin</span><span class="p">)</span> 
            <span class="p">{</span>
                <span class="nx">origin</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">originalEvent</span> <span class="o">?</span> <span class="nx">event</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">.</span><span class="nx">origin</span> <span class="o">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">origin</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">isOriginMatch</span><span class="p">(</span><span class="nx">allowedOriginOrFunction</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">originalEvent</span> <span class="o">?</span> <span class="nx">event</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">.</span><span class="nx">origin</span> <span class="o">:</span> <span class="nx">origin</span><span class="p">)</span> <span class="o">?</span>
                <span class="nx">callback</span><span class="p">({</span> <span class="s2">&quot;data&quot;</span><span class="o">:</span> <span class="nx">data</span><span class="p">,</span> <span class="s2">&quot;origin&quot;</span><span class="o">:</span> <span class="nx">origin</span> <span class="p">})</span> <span class="o">:</span> 
                <span class="kc">false</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Windows in IE can only handle onmessage events from IFRAMEs within the same parent window only.
Messages sent between top level windows will fail. Unfortunately, we don't know if the calling window is
an IFrame or top-level window. To work around, listen for calls from the polyfill technique for IE in all cases.</p></div></div><div class="code"><div class="wrapper">    <span class="nb">window</span><span class="p">.</span><span class="nx">__receiveMessageHook</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">origin</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">$evt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Event</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">);</span>
        <span class="nx">$evt</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">message</span><span class="p">;</span>
        <span class="nx">$evt</span><span class="p">.</span><span class="nx">origin</span> <span class="o">=</span> <span class="nx">origin</span><span class="p">;</span>
        
        <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">$evt</span><span class="p">,</span> <span class="p">[</span><span class="nx">$evt</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">$evt</span><span class="p">.</span><span class="nx">origin</span><span class="p">]);</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Convenience wrapper for windows wrapped in jQuery objects</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">postMessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">targetHost</span><span class="p">,</span> <span class="cm">/* optional */</span> <span class="nx">targetWindowName</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">el</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">el</span> <span class="k">instanceof</span> <span class="nx">Window</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;postMessage can only be sent to a window&quot;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="nx">$</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">targetHost</span><span class="p">,</span> <span class="nx">el</span><span class="p">,</span> <span class="nx">targetWindowName</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="nx">$</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">special</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> 
    <span class="p">{</span>
        <span class="nx">add</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">handlerData</span><span class="p">)</span> 
        <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">origHandler</span> <span class="o">=</span> <span class="nx">handlerData</span><span class="p">.</span><span class="nx">handler</span><span class="p">;</span>

            <span class="nx">handlerData</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">origin</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nx">e</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">originalEvent</span> <span class="o">?</span> <span class="nx">e</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">.</span><span class="nx">data</span> <span class="o">:</span> <span class="nx">message</span><span class="p">;</span>
                <span class="nx">e</span><span class="p">.</span><span class="nx">origin</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">originalEvent</span> <span class="o">?</span> <span class="nx">e</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">.</span><span class="nx">origin</span> <span class="o">:</span> <span class="nx">origin</span><span class="p">;</span>

                <span class="k">return</span> <span class="nx">origHandler</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">origin</span><span class="p">);</span>
            <span class="p">};</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">getPolyfillPath</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">_jqueryPostMessagePolyfillPath</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Must configure jquery.postMessage() with window._jqueryPostMessagePolyfillPath for IE7 support. Should be &#39;/root-relative-path-on-my-server/postmessage.htm&#39;&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">_jqueryPostMessagePolyfillPath</span><span class="p">;</span>
    <span class="p">};</span>

<span class="p">})(</span><span class="nb">window</span><span class="p">,</span> <span class="nx">jQuery</span><span class="p">);</span></div></div></div></div></body></html>