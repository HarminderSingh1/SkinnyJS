<!DOCTYPE html><html lang="en"><head><title>js\jquery.menu</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="js\jquery.menu"><meta name="groc-project-path" content="js\jquery.menu.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">js\jquery.menu.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="cm">/* global DocumentTouch */</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><a href="http://labaneilers.github.io/SkinnyJS/">Homepage</a> | 
<a href="https://github.com/labaneilers/SkinnyJS/blob/master/js/jquery.menu.js" target="_blank">View this file on Github</a> | 
<a href="https://raw.github.com/labaneilers/SkinnyJS/master/js/jquery.menu.js" target="_blank">Download this file</a>

<hr style="height: 1px; border:0; background-color:#4A525A">
<p>TODO: Support modifying state in the future by storing an object using $.data(), implement $(selector).dropDownMenu("option", value);
TODO: Accessibility: Keyboard navigation (tab navigation already works)- close submenus on pressing enter (maybe)</p></div></div><div class="code"><div class="wrapper"><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_skins</span> <span class="o">=</span> <span class="p">{};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Register skins by name for rendering the menu.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">.</span><span class="nx">registerDropDownMenuSkin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">skin</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">_skins</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">skin</span><span class="p">;</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: Promote to a plugin?</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">swapClasses</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">class1</span><span class="p">,</span> <span class="nx">class2</span><span class="p">,</span> <span class="nx">enabled</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">classToAdd</span> <span class="o">=</span> <span class="nx">enabled</span> <span class="o">?</span> <span class="nx">class1</span> <span class="o">:</span> <span class="nx">class2</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">classToRemove</span> <span class="o">=</span> <span class="nx">enabled</span> <span class="o">?</span> <span class="nx">class2</span> <span class="o">:</span> <span class="nx">class1</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="nx">classToAdd</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">classToAdd</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="nx">classToRemove</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Touch screen detection
Adapted from Modernizr. There's got to be a better way to reuse this kind of thing
optionally, without sucking in a ton of dependencies.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">_isTouchScreen</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ontouchstart&#39;</span> <span class="k">in</span> <span class="nb">window</span><span class="p">)</span> <span class="o">||</span> 
        <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">DocumentTouch</span> <span class="o">&amp;&amp;</span> <span class="nb">document</span> <span class="k">instanceof</span> <span class="nx">DocumentTouch</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Hover highlighting</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">highlightMenuItem</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$item</span><span class="p">,</span> <span class="nx">enabled</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">$item</span><span class="p">.</span><span class="nx">swapClasses</span><span class="p">(</span><span class="s2">&quot;hover&quot;</span><span class="p">,</span> <span class="s2">&quot;nohover&quot;</span><span class="p">,</span> <span class="nx">enabled</span><span class="p">);</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: It would be nice to have a jQuery.findUntil(selector)
This is a simple substitute. Recurse until the an element is found
with the specified class, and then stop searching in that node.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">findUntilInternal</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">fnIsMatch</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">!==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">fnIsMatch</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">elem</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">len</span><span class="o">=</span><span class="nx">elem</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">findUntilInternal</span><span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">fnIsMatch</span><span class="p">,</span> <span class="nx">results</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="c1">//jQuery wrapper</span>
    <span class="kd">var</span> <span class="nx">findUntil</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$elem</span><span class="p">,</span> <span class="nx">fnIsMatch</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="nx">$elem</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="nx">findUntilInternal</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">fnIsMatch</span><span class="p">,</span> <span class="nx">results</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="nx">results</span><span class="p">);</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Merges default options into the options passed in.
Ensures that functions passed as null/undefined in options are replaced
with no-op functions.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">mergeOptions</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">defaults</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">merged</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">.</span><span class="nx">apply</span><span class="p">({},</span> <span class="nx">arguments</span><span class="p">);</span>

        <span class="c1">//Ensure options have functions, even if they were passed as null/undefined</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">option</span> <span class="k">in</span> <span class="nx">merged</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">defaults</span><span class="p">[</span><span class="nx">option</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span> <span class="o">&amp;&amp;</span>
                <span class="k">typeof</span> <span class="nx">merged</span><span class="p">[</span><span class="nx">option</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nx">merged</span><span class="p">[</span><span class="nx">option</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">noop</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">merged</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">_defaults</span> <span class="o">=</span> 
    <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>When true, the top level menu opens on mouseover (instead of on click, which is the default).</p></div></div><div class="code"><div class="wrapper">        <span class="nx">showOnHover</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>When true, and showOnHover is enabled, clicking an A tag within a menu item that contains a submenu will be allowed to navigate
NOTE: This option is ignored when showOnHover is false.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">linksWithSubmenusEnabled</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Event which fires when a menu item is selected.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">selected</span><span class="o">:</span> <span class="nx">$</span><span class="p">.</span><span class="nx">noop</span><span class="p">,</span> </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Event which fires before a menu panel is show. Can be used to prevent the panel from showing.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">beforeShowPanel</span><span class="o">:</span> <span class="nx">$</span><span class="p">.</span><span class="nx">noop</span><span class="p">,</span> </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Event which fires before a menu panel is hidden. Can be used to prevent the panel from hiding.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">beforeHidePanel</span><span class="o">:</span> <span class="nx">$</span><span class="p">.</span><span class="nx">noop</span><span class="p">,</span> </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Event which fires after a panel is shown.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">showPanelComplete</span><span class="o">:</span> <span class="nx">$</span><span class="p">.</span><span class="nx">noop</span><span class="p">,</span> </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Event which fires after a panel is hidden.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">hidePanelComplete</span><span class="o">:</span> <span class="nx">$</span><span class="p">.</span><span class="nx">noop</span><span class="p">,</span> </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Event which allows overriding the positioning of a panel when it is shown. 
This is defined by the skin by default, but can be overridden for any instance of the menu.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">position</span><span class="o">:</span> <span class="nx">$</span><span class="p">.</span><span class="nx">noop</span><span class="p">,</span>
            </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The predefined skin to use for rendering this instance</p></div></div><div class="code"><div class="wrapper">        <span class="nx">skin</span><span class="o">:</span> <span class="s2">&quot;basic&quot;</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Dropdown menu plugin. The jQuery element collection should include
top-level container elements which in turn contain items with class "menu-item".
Each item in the jQuery collection becomes a menu "group".</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">dropDownMenu</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Map skin from the registered skin collection</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">_skin</span> <span class="o">=</span> <span class="nx">_skins</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">skin</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_skin</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Invalid dropDownMenu skin: &quot;</span> <span class="o">+</span> <span class="nx">options</span><span class="p">.</span><span class="nx">skin</span><span class="p">);</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Merge explicit options with skin and defaults</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">_options</span> <span class="o">=</span> <span class="nx">mergeOptions</span><span class="p">({},</span> <span class="nx">_defaults</span><span class="p">,</span> <span class="nx">_skin</span> <span class="o">||</span> <span class="p">{},</span> <span class="nx">options</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Resolve conflicting options</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_options</span><span class="p">.</span><span class="nx">showOnHover</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nx">_options</span><span class="p">.</span><span class="nx">linksWithSubmenusEnabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Mimics the delay time in Windows/MacOS</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">FADE_MS</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span>
        </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Creates a menu "group" from a jQuery collection of top-level
menu items. This will be called once for each element in the
top level jQuery object's collection.</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">createMenuFromTopMenuItems</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$topLevelItems</span><span class="p">)</span>
        <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Assign a CSS class to help distinguish between top-level
and sub menus.</p></div></div><div class="code"><div class="wrapper">            <span class="nx">$topLevelItems</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;menu-item-top&quot;</span><span class="p">);</span>

            <span class="kd">var</span> <span class="nx">_panels</span> <span class="o">=</span> <span class="p">[];</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The menu panel heirarchy root element</p></div></div><div class="code"><div class="wrapper">            <span class="kd">var</span> <span class="nx">_rootMenu</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">parent</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
                <span class="nx">children</span><span class="o">:</span> <span class="p">[]</span>
            <span class="p">};</span>
            </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>When a top menu button is clicked, the menu
begins to react to hover events (mimics Windows/MacOS menus).</p></div></div><div class="code"><div class="wrapper">            <span class="kd">var</span> <span class="nx">_clickHoverActivated</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Used to signal the document click handler that 
the click came from the menu, so it should be ignored.</p></div></div><div class="code"><div class="wrapper">            <span class="kd">var</span> <span class="nx">_ignoreDocumentClick</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            
            <span class="kd">var</span> <span class="nx">Panel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$panel</span><span class="p">,</span> <span class="nx">$item</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">me</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
                
                <span class="k">this</span><span class="p">.</span><span class="nx">$panel</span> <span class="o">=</span> <span class="nx">$panel</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">$item</span> <span class="o">=</span> <span class="nx">$item</span> <span class="o">||</span> <span class="nx">$panel</span><span class="p">.</span><span class="nx">closest</span><span class="p">(</span><span class="s2">&quot;.menu-item&quot;</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">$parentPanel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$item</span><span class="p">.</span><span class="nx">closest</span><span class="p">(</span><span class="s2">&quot;.menu-panel&quot;</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">isTopLevel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$parentPanel</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
                
                <span class="k">this</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="p">[];</span>
                </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Indicates the Panel is open (expanded)</p></div></div><div class="code"><div class="wrapper">                <span class="k">this</span><span class="p">.</span><span class="nx">isOpen</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Indicates that the panel is in the middle of showing/hiding</p></div></div><div class="code"><div class="wrapper">                <span class="k">this</span><span class="p">.</span><span class="nx">transitioning</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Store a reference to this instance from the DOM element</p></div></div><div class="code"><div class="wrapper">                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$panel</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">$panel</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s2">&quot;PanelInstance&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
                <span class="p">}</span>
                </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Bind event handlers to DOM elements</p></div></div><div class="code"><div class="wrapper">                <span class="kd">var</span> <span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
                <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Assign a special class to distinguish menu items with a submenu
from those without one.</p></div></div><div class="code"><div class="wrapper">                    <span class="nx">me</span><span class="p">.</span><span class="nx">$item</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;menu-item-with-submenu&quot;</span><span class="p">);</span>

                    <span class="nx">me</span><span class="p">.</span><span class="nx">$item</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click touchstart&quot;</span><span class="p">,</span> <span class="nx">toggleClick</span><span class="p">);</span>
                    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set up event handlers to control submenus appearing on hover</p></div></div><div class="code"><div class="wrapper">                    <span class="nx">me</span><span class="p">.</span><span class="nx">$item</span><span class="p">.</span><span class="nx">hoverDelay</span><span class="p">({</span> 
                        <span class="nx">over</span><span class="o">:</span> <span class="nx">mouseOver</span><span class="p">,</span> 
                        <span class="nx">out</span><span class="o">:</span> <span class="nx">mouseOut</span><span class="p">,</span> 
                        <span class="nx">delayOver</span><span class="o">:</span> <span class="nx">me</span><span class="p">.</span><span class="nx">isTopLevel</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_options</span><span class="p">.</span><span class="nx">showOnHover</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">200</span><span class="p">,</span> 
                        <span class="nx">delayOut</span><span class="o">:</span><span class="mi">500</span> 
                    <span class="p">});</span>
                    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Top menu items have different rules for rollovers (mimics Windows/MacOS menus)</p></div></div><div class="code"><div class="wrapper">                    <span class="k">if</span> <span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">isTopLevel</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="nx">me</span><span class="p">.</span><span class="nx">$item</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseout&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">me</span><span class="p">.</span><span class="nx">isOpen</span><span class="p">)</span>
                            <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prevent mouseouts when rolling over tags within the same menu item.</p></div></div><div class="code"><div class="wrapper">                                <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">relatedTarget</span><span class="p">)</span>
                                <span class="p">{</span>   
                                    <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">has</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">relatedTarget</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">is</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">relatedTarget</span><span class="p">))</span>
                                    <span class="p">{</span>
                                        <span class="k">return</span><span class="p">;</span>
                                    <span class="p">}</span>
                                <span class="p">}</span>

                                <span class="nx">highlight</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
                            <span class="p">}</span>
                        <span class="p">});</span>
                    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Note: It is legitimate to have a Panel object without a submenu.</p></div></div><div class="code"><div class="wrapper">                    <span class="k">if</span> <span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">$panel</span><span class="p">)</span>
                    <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Event handler for clicking on panels. 
Handles firing the "selected" event.</p></div></div><div class="code"><div class="wrapper">                        <span class="nx">me</span><span class="p">.</span><span class="nx">$panel</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> 
                        <span class="p">{</span> </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Find the parent menu item of the clicked element.</p></div></div><div class="code"><div class="wrapper">                            <span class="kd">var</span> <span class="nx">$clickedMenuItem</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">closest</span><span class="p">(</span><span class="s2">&quot;.menu-item&quot;</span><span class="p">,</span> <span class="nx">me</span><span class="p">.</span><span class="nx">$panel</span><span class="p">);</span>
                        
                            <span class="k">if</span> <span class="p">(</span><span class="nx">$clickedMenuItem</span><span class="p">)</span>
                            <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If the menu item has a submenu, then it shouldn't
fire selected- it just opens the submenu.</p></div></div><div class="code"><div class="wrapper">                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">$clickedMenuItem</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="s2">&quot;menu-item-with-submenu&quot;</span><span class="p">))</span>
                                <span class="p">{</span>
                                    <span class="kd">var</span> <span class="nx">ev</span> <span class="o">=</span> <span class="nx">getEvent</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
                                    <span class="nx">ev</span><span class="p">.</span><span class="nx">$selectedItem</span> <span class="o">=</span> <span class="nx">$clickedMenuItem</span><span class="p">;</span>
                                    <span class="nx">ev</span><span class="p">.</span><span class="nx">selectedItem</span> <span class="o">=</span> <span class="nx">$clickedMenuItem</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                                
                                    <span class="nx">_options</span><span class="p">.</span><span class="nx">selected</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">ev</span><span class="p">);</span>
                                </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Give the event handler a chance to cancel the event.</p></div></div><div class="code"><div class="wrapper">                                    <span class="k">if</span> <span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">cancel</span><span class="p">)</span>
                                    <span class="p">{</span>
                                        <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
                                        <span class="k">return</span><span class="p">;</span>
                                    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If this is a click on a leaf node, and the window is navigating, don't hide the menu.</p></div></div><div class="code"><div class="wrapper">                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">e</span><span class="p">.</span><span class="nx">isDefaultPrevented</span><span class="p">())</span>
                                    <span class="p">{</span>
                                        <span class="k">return</span><span class="p">;</span>
                                    <span class="p">}</span>
                                </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The clicked element was a menu item with no sub-menu: hide.</p></div></div><div class="code"><div class="wrapper">                                    <span class="nx">hideAllClick</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                        
                            <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
                        <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Ensure a tags within a menu item with a submenu get disabled</p></div></div><div class="code"><div class="wrapper">                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_options</span><span class="p">.</span><span class="nx">linksWithSubmenusEnabled</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="nx">getLinksWithSubmenus</span><span class="p">().</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="nx">preventDefault</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">};</span>

                <span class="kd">var</span> <span class="nx">preventDefault</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
                <span class="p">};</span>

                <span class="kd">var</span> <span class="nx">getLinksWithSubmenus</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
                <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">findUntil</span><span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">$item</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span>
                    <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Stop searching once we get to the nested panel.
We're only interested in A tags owned by this specific
menu item.</p></div></div><div class="code"><div class="wrapper">                        <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">elem</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s2">&quot;menu-panel&quot;</span><span class="p">))</span>
                        <span class="p">{</span>
                            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add links found to the results</p></div></div><div class="code"><div class="wrapper">                        <span class="k">if</span> <span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">tagName</span> <span class="o">==</span> <span class="s2">&quot;A&quot;</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">elem</span><span class="p">);</span>
                        <span class="p">}</span>

                        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="p">});</span>
                <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Resolves the .parent property and adds this Panel
to the parent's children property.</p></div></div><div class="code"><div class="wrapper">                <span class="k">this</span><span class="p">.</span><span class="nx">resolveParent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
                <span class="p">{</span>
                    <span class="nx">me</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="nx">me</span><span class="p">.</span><span class="nx">$parentPanel</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s2">&quot;PanelInstance&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">_rootMenu</span><span class="p">;</span>
                    <span class="nx">me</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">me</span><span class="p">);</span>
                <span class="p">};</span>
                
                <span class="kd">var</span> <span class="nx">_level</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Gets the level of the Panel in the heirarchy. 0 is the root menu item.</p></div></div><div class="code"><div class="wrapper">                <span class="k">this</span><span class="p">.</span><span class="nx">getLevel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">_level</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="nx">_level</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// Account for _rootMenu: first level menu should be level 0</span>
                        <span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">me</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
                        <span class="k">while</span> <span class="p">(</span><span class="nx">current</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="nx">current</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
                            <span class="nx">_level</span><span class="o">++</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    
                    <span class="k">return</span> <span class="nx">_level</span><span class="p">;</span>
                <span class="p">};</span>
                
                <span class="kd">var</span> <span class="nx">_siblings</span><span class="p">;</span>
                </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Gets an array of the siblings of this Panel (Panels with the same parent)</p></div></div><div class="code"><div class="wrapper">                <span class="k">this</span><span class="p">.</span><span class="nx">getSiblings</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_siblings</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="nx">_siblings</span> <span class="o">=</span> <span class="p">[];</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span>
                            <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="k">this</span> <span class="o">!==</span> <span class="nx">me</span><span class="p">)</span>
                                <span class="p">{</span>
                                    <span class="nx">_siblings</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
                                <span class="p">}</span>
                            <span class="p">});</span>
                        <span class="p">}</span>
                    <span class="p">}</span>

                    <span class="k">return</span> <span class="nx">_siblings</span><span class="p">;</span>
                <span class="p">};</span>
                </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO use a jQuery event
Creates a new "fake" event for passing to event handlers</p></div></div><div class="code"><div class="wrapper">                <span class="kd">var</span> <span class="nx">getEvent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">return</span> <span class="p">{</span>
                        <span class="nx">$panel</span><span class="o">:</span> <span class="nx">me</span><span class="p">.</span><span class="nx">$panel</span><span class="p">,</span>
                        <span class="nx">panel</span><span class="o">:</span> <span class="nx">me</span><span class="p">,</span>
                        <span class="nx">$parentPanel</span><span class="o">:</span> <span class="nx">me</span><span class="p">.</span><span class="nx">$parentPanel</span><span class="p">,</span>
                        <span class="nx">parentPanel</span><span class="o">:</span> <span class="nx">me</span><span class="p">.</span><span class="nx">$parentPanel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="nx">$item</span><span class="o">:</span> <span class="nx">me</span><span class="p">.</span><span class="nx">$item</span><span class="p">,</span>
                        <span class="nx">item</span><span class="o">:</span> <span class="nx">me</span><span class="p">.</span><span class="nx">$item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="nx">level</span><span class="o">:</span> <span class="nx">me</span><span class="p">.</span><span class="nx">getLevel</span><span class="p">(),</span>
                        <span class="nx">innerEvent</span><span class="o">:</span> <span class="nx">e</span><span class="p">,</span>
                        <span class="nx">preventDefault</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span>
                        <span class="p">{</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">cancel</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">};</span>
                <span class="p">};</span>
                </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Adds/removes the "hover" class. Allows callers to 
define their own rollover states.
Note: We cant use CSS hover pseudo-classes because the rules
for Windows/MacOS style menus don't follow the same rules.</p></div></div><div class="code"><div class="wrapper">                <span class="kd">var</span> <span class="nx">highlight</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">enabled</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="nx">highlightMenuItem</span><span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">$item</span><span class="p">,</span> <span class="nx">enabled</span><span class="p">);</span>
                <span class="p">};</span>
                </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Determines if the current menu should show on hover (in addition to click)</p></div></div><div class="code"><div class="wrapper">                <span class="kd">var</span> <span class="nx">shouldShowSubmenuOnHover</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">me</span><span class="p">.</span><span class="nx">isTopLevel</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="p">}</span>
                    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If this is the top menu, only react to a mouseover event
if we're in "hover mode" (there has already been a click),
or if we're in the "always on" hover mode.</p></div></div><div class="code"><div class="wrapper">                    <span class="k">return</span> <span class="nx">_clickHoverActivated</span> <span class="o">||</span> <span class="nx">_options</span><span class="p">.</span><span class="nx">showOnHover</span><span class="p">;</span>
                <span class="p">};</span>

                <span class="kd">var</span> <span class="nx">mouseOver</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
                <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>In Windows/MacOS, top level menus highlight instantly, with no delay</p></div></div><div class="code"><div class="wrapper">                    <span class="k">if</span> <span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">isTopLevel</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="nx">highlight</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
                    <span class="p">}</span>
                    
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">shouldShowSubmenuOnHover</span><span class="p">())</span>
                    <span class="p">{</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="nx">me</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
                <span class="p">};</span>
                
                <span class="kd">var</span> <span class="nx">mouseOut</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">isTopLevel</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_options</span><span class="p">.</span><span class="nx">showOnHover</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>
                
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">shouldShowSubmenuOnHover</span><span class="p">())</span>
                    <span class="p">{</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="nx">me</span><span class="p">.</span><span class="nx">hide</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
                <span class="p">};</span>
                </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Shows the panel</p></div></div><div class="code"><div class="wrapper">                <span class="k">this</span><span class="p">.</span><span class="nx">show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">transitioning</span> <span class="o">||</span> <span class="nx">me</span><span class="p">.</span><span class="nx">isOpen</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="kd">var</span> <span class="nx">ev</span><span class="p">;</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">$panel</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="nx">ev</span> <span class="o">=</span> <span class="nx">getEvent</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
                    
                        <span class="nx">_options</span><span class="p">.</span><span class="nx">beforeShowPanel</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">me</span><span class="p">,</span> <span class="nx">ev</span><span class="p">);</span>
                    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Give the handler a chance to cancel the event</p></div></div><div class="code"><div class="wrapper">                        <span class="k">if</span> <span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">cancel</span><span class="p">)</span>
                        <span class="p">{</span>    
                            <span class="k">return</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Ensure that all siblings are hidden</p></div></div><div class="code"><div class="wrapper">                    <span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">getSiblings</span><span class="p">(),</span> <span class="kd">function</span><span class="p">()</span>
                    <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">hide</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
                    <span class="p">});</span>

                    <span class="nx">hideOtherMenus</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
                    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Ensure the current menu item is highlighted</p></div></div><div class="code"><div class="wrapper">                    <span class="nx">highlight</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">me</span><span class="p">.</span><span class="nx">$panel</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="nx">me</span><span class="p">.</span><span class="nx">transitioning</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Hook for positioning strategies</p></div></div><div class="code"><div class="wrapper">                    <span class="nx">ev</span> <span class="o">=</span> <span class="nx">getEvent</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
                    <span class="nx">_options</span><span class="p">.</span><span class="nx">position</span><span class="p">(</span><span class="nx">ev</span><span class="p">);</span>
                    
                    <span class="k">if</span> <span class="p">(</span><span class="nx">_options</span><span class="p">.</span><span class="nx">animationShow</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="nx">_options</span><span class="p">.</span><span class="nx">animationShow</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">me</span><span class="p">,</span> <span class="nx">ev</span><span class="p">,</span> <span class="nx">showComplete</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">isTopLevel</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="nx">$panel</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
                        <span class="nx">showComplete</span><span class="p">();</span>
                    <span class="p">}</span>
                    <span class="k">else</span>
                    <span class="p">{</span>
                        <span class="nx">$panel</span><span class="p">.</span><span class="nx">fadeIn</span><span class="p">(</span><span class="nx">FADE_MS</span><span class="p">,</span> <span class="nx">showComplete</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">};</span>
                
                <span class="kd">var</span> <span class="nx">showComplete</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="nx">me</span><span class="p">.</span><span class="nx">isOpen</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="nx">me</span><span class="p">.</span><span class="nx">transitioning</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                    
                    <span class="nx">_options</span><span class="p">.</span><span class="nx">showPanelComplete</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">me</span><span class="p">,</span> <span class="nx">getEvent</span><span class="p">(</span><span class="nx">e</span><span class="p">));</span>
                <span class="p">};</span>
        
                <span class="k">this</span><span class="p">.</span><span class="nx">hide</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">me</span><span class="p">.</span><span class="nx">isOpen</span> <span class="o">||</span> <span class="nx">me</span><span class="p">.</span><span class="nx">transitioning</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">$panel</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">ev</span> <span class="o">=</span> <span class="nx">getEvent</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
                    
                        <span class="nx">_options</span><span class="p">.</span><span class="nx">beforeHidePanel</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">me</span><span class="p">,</span> <span class="nx">ev</span><span class="p">);</span>
                    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Give the handler a chance to cancel the event</p></div></div><div class="code"><div class="wrapper">                        <span class="k">if</span> <span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">cancel</span><span class="p">)</span>
                        <span class="p">{</span>    
                            <span class="k">return</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>

                    <span class="nx">highlight</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">me</span><span class="p">.</span><span class="nx">$panel</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>
                    
                    <span class="nx">me</span><span class="p">.</span><span class="nx">transitioning</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

                    <span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span>
                    <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">hide</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
                    <span class="p">});</span>
                    
                    <span class="k">if</span> <span class="p">(</span><span class="nx">_options</span><span class="p">.</span><span class="nx">animationHide</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="nx">_options</span><span class="p">.</span><span class="nx">animationHide</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">me</span><span class="p">,</span> <span class="nx">getEvent</span><span class="p">(</span><span class="nx">e</span><span class="p">),</span> <span class="nx">hideComplete</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">isTopLevel</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="nx">$panel</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
                        <span class="nx">hideComplete</span><span class="p">();</span>
                    <span class="p">}</span>
                    <span class="k">else</span>
                    <span class="p">{</span>
                        <span class="nx">$panel</span><span class="p">.</span><span class="nx">fadeOut</span><span class="p">(</span><span class="nx">FADE_MS</span><span class="p">,</span> <span class="nx">hideComplete</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">};</span>
                
                <span class="kd">var</span> <span class="nx">hideComplete</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="nx">me</span><span class="p">.</span><span class="nx">isOpen</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                    <span class="nx">me</span><span class="p">.</span><span class="nx">transitioning</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

                    <span class="nx">_options</span><span class="p">.</span><span class="nx">hidePanelComplete</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">me</span><span class="p">,</span> <span class="nx">getEvent</span><span class="p">(</span><span class="nx">e</span><span class="p">));</span>
                <span class="p">};</span>
                
                <span class="kd">var</span> <span class="nx">toggleClick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">isBubbledClick</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">$panel</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">$closestPanel</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">closest</span><span class="p">(</span><span class="s2">&quot;.menu-panel&quot;</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">$closestPanel</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">$closestPanel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="nx">me</span><span class="p">.</span><span class="nx">$panel</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="p">{</span>
                            <span class="nx">isBubbledClick</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>This event bubbled from a child panel's link (a leaf menu item).
It doesn't have a Panel object of its own, so it should act like a regular link.</p></div></div><div class="code"><div class="wrapper">                    <span class="k">if</span> <span class="p">(</span><span class="nx">isBubbledClick</span><span class="p">)</span>
                    <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Don't let the document handler catch this event, or the menu would close.</p></div></div><div class="code"><div class="wrapper">                        <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>For touch events that aren't from leaf menu items,
cancel the default event so touching the menu doesn't cause navigation.</p></div></div><div class="code"><div class="wrapper">                    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;touchstart&quot;</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
                        <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">transitioning</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>
                    
                    <span class="nx">me</span><span class="p">[</span><span class="nx">me</span><span class="p">.</span><span class="nx">isOpen</span> <span class="o">?</span> <span class="s2">&quot;hideClick&quot;</span> <span class="o">:</span> <span class="s2">&quot;showClick&quot;</span><span class="p">](</span><span class="nx">e</span><span class="p">);</span>
                    
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">me</span><span class="p">.</span><span class="nx">isTopLevel</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>            
                    <span class="p">}</span>
                    <span class="k">else</span>
                    <span class="p">{</span>
                        <span class="nx">_ignoreDocumentClick</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">};</span>
                
                <span class="kd">var</span> <span class="nx">showClick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">isTopLevel</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="nx">_clickHoverActivated</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="p">}</span>
                    
                    <span class="nx">me</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
                <span class="p">};</span>
                
                <span class="k">this</span><span class="p">.</span><span class="nx">hideClick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">isTopLevel</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="nx">_clickHoverActivated</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                    <span class="p">}</span>
                    
                    <span class="nx">me</span><span class="p">.</span><span class="nx">hide</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
                <span class="p">};</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">hideForce</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="nx">_clickHoverActivated</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                    <span class="nx">me</span><span class="p">.</span><span class="nx">hide</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
                <span class="p">};</span>
                
                <span class="nx">init</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
            <span class="p">};</span>
            </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Hides all menus and submenus</p></div></div><div class="code"><div class="wrapper">            <span class="kd">var</span> <span class="nx">hideAllClick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nx">_ignoreDocumentClick</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

                <span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">_rootMenu</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span>
                <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">hideForce</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
                <span class="p">});</span>
            <span class="p">};</span>
            </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Handler for a document click to close all menus</p></div></div><div class="code"><div class="wrapper">            <span class="kd">var</span> <span class="nx">documentClickHandler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
            <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check a flag which indicates the click is from the menu itself</p></div></div><div class="code"><div class="wrapper">                <span class="k">if</span> <span class="p">(</span><span class="nx">_ignoreDocumentClick</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="nx">_ignoreDocumentClick</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="nx">hideAllClick</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
            <span class="p">};</span>

            <span class="nx">_allCloseHandlers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">hideAllClick</span><span class="p">);</span>

            <span class="kd">var</span> <span class="nx">hideOtherMenus</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">_allCloseHandlers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">_allCloseHandlers</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">hideAllClick</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="nx">_allCloseHandlers</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="nx">e</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create a Panel instance for each menu panel, store in an array</p></div></div><div class="code"><div class="wrapper">            <span class="nx">$topLevelItems</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.menu-panel&quot;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> 
            <span class="p">{</span> 
                <span class="nx">_panels</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">Panel</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">)));</span> 
            <span class="p">});</span>
            </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Top level items without a submenu need a Panel instance as well, to interact with other top level items.</p></div></div><div class="code"><div class="wrapper">            <span class="nx">$topLevelItems</span><span class="p">.</span><span class="nx">not</span><span class="p">(</span><span class="s2">&quot;.menu-item-with-submenu&quot;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> 
            <span class="p">{</span> 
                <span class="nx">_panels</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">Panel</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">)));</span> 
            <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Build a tree representing the parent/child relationships in the menu</p></div></div><div class="code"><div class="wrapper">            <span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">_panels</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">resolveParent</span><span class="p">();</span> <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set up rollovers on the menu items.
Note: This does not include the top level items with submenus, which have different
rules for rollovers. jQuery.find() only includes decendants, no the current set,
which is the top level menu items.</p></div></div><div class="code"><div class="wrapper">            <span class="nx">$topLevelItems</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.menu-item&quot;</span><span class="p">).</span><span class="nx">hover</span><span class="p">(</span>
                <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">highlightMenuItem</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="kc">true</span><span class="p">);</span> <span class="p">},</span> 
                <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">highlightMenuItem</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="kc">false</span><span class="p">);</span> <span class="p">})</span>
                <span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">highlightMenuItem</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="kc">false</span><span class="p">);</span> <span class="p">});</span>
            </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Bind a handler to close the menu if it is clicked off.</p></div></div><div class="code"><div class="wrapper">            <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="nx">documentClickHandler</span><span class="p">);</span>
        <span class="p">};</span>
        </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Loop through each menu container and create a menu "group".</p></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> 
        <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Find all the top-level menu items within the container.</p></div></div><div class="code"><div class="wrapper">            <span class="kd">var</span> <span class="nx">$topLevelItems</span> <span class="o">=</span> <span class="nx">findUntil</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> 
            <span class="p">{</span> 
                <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">elem</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s2">&quot;menu-item&quot;</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">elem</span><span class="p">);</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Invoke the create menu function with a jQuery object
containing all the top level menu items.</p></div></div><div class="code"><div class="wrapper">            <span class="nx">createMenuFromTopMenuItems</span><span class="p">(</span><span class="nx">$topLevelItems</span><span class="p">);</span>
        <span class="p">});</span>
        </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Allow the jQuery chain to remain unbroken.</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">_allCloseHandlers</span> <span class="o">=</span> <span class="p">[];</span>
    
<span class="p">})(</span><span class="nx">jQuery</span><span class="p">);</span></div></div></div></div></body></html>